<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اسکنر و تولید کننده QR کد</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @font-face {
            font-family: 'Vazir';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir.woff2') format('woff2');
        }
        body {
            font-family: 'Vazir', sans-serif;
        }
        .camera-container {
            aspect-ratio: 1/1;
        }
        #qr-video {
            transform: scaleX(-1);
        }
        .history-item:hover {
            background-color: #f0fdf4;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-green-600 mb-2">QR کد اسکنر</h1>
            <p class="text-gray-600">اسکن و تولید QR کد به سادگی</p>
        </header>

        <!-- Main Tabs -->
        <div class="mb-6 flex justify-center">
            <div class="flex bg-white rounded-lg shadow overflow-hidden">
                <button id="scan-tab" class="px-6 py-3 bg-green-600 text-white font-medium">اسکن QR کد</button>
                <button id="generate-tab" class="px-6 py-3 text-gray-700 font-medium hover:bg-green-50">تولید QR کد</button>
                <button id="history-tab" class="px-6 py-3 text-gray-700 font-medium hover:bg-green-50">تاریخچه</button>
            </div>
        </div>

        <!-- Scan Tab Content -->
        <div id="scan-content" class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-green-600">اسکن QR کد</h2>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">برای اسکن QR کد، لطفاً دسترسی به دوربین را تأیید کنید:</p>
                <button id="start-camera" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    فعال‌سازی دوربین
                </button>
            </div>
            
            <div id="camera-access" class="hidden">
                <div class="camera-container relative bg-black rounded-lg overflow-hidden mb-4">
                    <video id="qr-video" class="w-full h-full object-cover"></video>
                    <div class="absolute inset-0 border-4 border-green-400 rounded-lg pointer-events-none"></div>
                    <button id="rotate-camera" class="absolute bottom-4 left-4 bg-green-600 text-white p-2 rounded-full hover:bg-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
                <div id="result" class="hidden p-4 bg-green-50 rounded-lg text-center">
                    <p id="qr-result" class="text-green-700"></p>
                </div>
            </div>
            
            <div id="permission-denied" class="hidden p-4 bg-red-50 rounded-lg text-center">
                <p class="text-red-600">دسترسی به دوربین داده نشد. لطفاً تنظیمات مرورگر خود را بررسی کنید.</p>
            </div>
        </div>

        <!-- Generate Tab Content -->
        <div id="generate-content" class="hidden bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-green-600">تولید QR کد</h2>
            <div class="mb-4">
                <label for="qr-text" class="block text-sm font-medium text-gray-700 mb-1">متن یا آدرس اینترنتی:</label>
                <input type="text" id="qr-text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="متن یا URL را وارد کنید">
                <button id="generate-qr" class="w-full mt-2 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    تولید QR کد
                </button>
            </div>
            
            <div id="qr-code-result" class="hidden flex flex-col items-center">
                <div id="qr-code" class="mb-4 p-4 bg-white border border-gray-200 rounded-lg"></div>
                <button id="download-qr" class="px-6 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">
                    دانلود QR کد
                </button>
            </div>
        </div>

        <!-- History Tab Content -->
        <div id="history-content" class="hidden bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4 text-green-600">تاریخچه اسکن‌ها</h2>
            <div id="history-list" class="divide-y divide-gray-200">
                <p id="empty-history" class="text-center text-gray-500 py-4">هنوز هیچ QR کدی اسکن نکرده‌اید.</p>
                <!-- History items will be added here dynamically -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Persian text constants
            const texts = {
                scanSuccess: "QR کد با موفقیت اسکن شد!",
                scanning: "در حال اسکن...",
                cameraDenied: "دسترسی به دوربین داده نشد.",
                qrGenerated: "QR کد با موفقیت تولید شد.",
                emptyInput: "لطفاً متن یا URL را وارد کنید."
            };

            // Tab switching
            const tabs = {
                scan: {
                    tab: document.getElementById('scan-tab'),
                    content: document.getElementById('scan-content')
                },
                generate: {
                    tab: document.getElementById('generate-tab'),
                    content: document.getElementById('generate-content')
                },
                history: {
                    tab: document.getElementById('history-tab'),
                    content: document.getElementById('history-content')
                }
            };

            function switchTab(activeTab) {
                Object.values(tabs).forEach(tab => {
                    tab.tab.classList.remove('bg-green-600', 'text-white');
                    tab.tab.classList.add('text-gray-700', 'hover:bg-green-50');
                    tab.content.classList.add('hidden');
                });

                activeTab.tab.classList.add('bg-green-600', 'text-white');
                activeTab.tab.classList.remove('text-gray-700', 'hover:bg-green-50');
                activeTab.content.classList.remove('hidden');
            }

            tabs.scan.tab.addEventListener('click', () => switchTab(tabs.scan));
            tabs.generate.tab.addEventListener('click', () => switchTab(tabs.generate));
            tabs.history.tab.addEventListener('click', () => switchTab(tabs.history));

            // QR Scanner functionality
            const video = document.getElementById('qr-video');
            const startCameraBtn = document.getElementById('start-camera');
            const cameraAccessDiv = document.getElementById('camera-access');
            const permissionDeniedDiv = document.getElementById('permission-denied');
            const resultDiv = document.getElementById('result');
            const qrResultP = document.getElementById('qr-result');
            const historyList = document.getElementById('history-list');
            const emptyHistory = document.getElementById('empty-history');

            let scanner = null;
            let scanning = false;

            startCameraBtn.addEventListener('click', async () => {
                try {
                    await initCamera(facingMode);
                    
                    cameraAccessDiv.classList.remove('hidden');
                    permissionDeniedDiv.classList.add('hidden');
                    startCameraBtn.classList.add('hidden');
                    
                    // Initialize QR scanner
                    if (!scanner) {
                        initializeScanner();
                    }
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    permissionDeniedDiv.classList.remove('hidden');
                }
            });

            let facingMode = 'environment'; // Default to rear camera
            
            document.getElementById('rotate-camera').addEventListener('click', async () => {
                if (scanner) {
                    scanner.stop();
                    facingMode = facingMode === 'user' ? 'environment' : 'user';
                    await initCamera(facingMode);
                }
            });

            async function initCamera(facingMode) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode } 
                    });
                    video.srcObject = stream;
                    video.play();
                    
                    if (scanner) {
                        scanner.setVideo(video);
                        scanner.start();
                    }
                } catch (error) {
                    console.error('Error rotating camera:', error);
                    permissionDeniedDiv.classList.remove('hidden');
                }
            }

            function initializeScanner() {
                scanner = new QrScanner(
                    video,
                    result => {
                        if (!scanning) {
                            scanning = true;
                            handleScanResult(result);
                        }
                    },
                    {
                        maxScansPerSecond: 10,
                        highlightScanRegion: true,
                        highlightCodeOutline: true,
                    }
                );
                scanner.start();
            }

            function handleScanResult(result) {
                qrResultP.textContent = result.data;
                resultDiv.classList.remove('hidden');
                
                // Save to history
                saveToHistory(result.data);
                
                if (isValidUrl(result.data)) {
                    window.location.href = result.data;
                } else {
                    Swal.fire({
                        title: texts.scanSuccess,
                        text: result.data,
                        icon: "info",
                        confirmButtonText: "باشه"
                    });
                }
                scanning = false;
            }

            function isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }

            function saveToHistory(data) {
                // Get existing history or initialize empty array
                let history = JSON.parse(localStorage.getItem('qrHistory')) || [];
                
                // Add new scan (with timestamp)
                history.unshift({
                    data: data,
                    date: new Date().toLocaleString('fa-IR'),
                    isUrl: isValidUrl(data)
                });
                
                // Keep only last 20 items
                if (history.length > 20) {
                    history = history.slice(0, 20);
                }
                
                // Save to localStorage
                localStorage.setItem('qrHistory', JSON.stringify(history));
                
                // Update history display
                renderHistory();
            }

            function renderHistory() {
                const history = JSON.parse(localStorage.getItem('qrHistory')) || [];
                
                if (history.length === 0) {
                    emptyHistory.classList.remove('hidden');
                    historyList.innerHTML = '';
                    return;
                }
                
                emptyHistory.classList.add('hidden');
                historyList.innerHTML = '';
                
                history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item py-3 px-4 cursor-pointer transition';
                    
                    let content = item.data;
                    if (content.length > 50) {
                        content = content.substring(0, 50) + '...';
                    }
                    
                    historyItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">${item.date}</p>
                                <p class="${item.isUrl ? 'text-green-600' : 'text-gray-800'}">${content}</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                    `;
                    
                    historyItem.addEventListener('click', () => {
                        if (item.isUrl) {
                            window.open(item.data, '_blank');
                        } else {
                            Swal.fire({
                                title: 'محتویات QR کد',
                                text: item.data,
                                icon: 'info'
                            });
                        }
                    });
                    
                    historyList.appendChild(historyItem);
                });
            }

            // QR Generator functionality
            const qrTextInput = document.getElementById('qr-text');
            const generateQrBtn = document.getElementById('generate-qr');
            const qrCodeResult = document.getElementById('qr-code-result');
            const qrCodeDiv = document.getElementById('qr-code');
            const downloadQrBtn = document.getElementById('download-qr');

            generateQrBtn.addEventListener('click', () => {
                const text = qrTextInput.value.trim();
                
                if (!text) {
                    Swal.fire({
                        title: 'خطا',
                        text: texts.emptyInput,
                        icon: 'error'
                    });
                    return;
                }
                
                // Generate QR code
                const qr = qrcode(0, 'L');
                qr.addData(text);
                qr.make();
                
                // If you want HTML output
                qrCodeDiv.innerHTML = qr.createSvgTag({
                    scaling: 10,
                    margin: 4,
                    fill: '#065f46'
                });
                
                // Set download handler
                const svg = qrCodeDiv.querySelector('svg');
                svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                
                downloadQrBtn.onclick = () => {
                    const serializer = new XMLSerializer();
                    const svgBlob = new Blob([serializer.serializeToString(svg)], {type: 'image/svg+xml;charset=utf-8'});
                    const url = URL.createObjectURL(svgBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `qr-code-${Date.now()}.svg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                
                qrCodeResult.classList.remove('hidden');
                
                Swal.fire({
                    title: texts.qrGenerated,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            });

            // Initialize history on load
            renderHistory();
        });
    </script>
</body>
</html>
