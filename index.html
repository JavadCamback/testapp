<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        #interactive {
            width: 100%;
            position: relative;
        }
        
        #interactive.viewport {
            position: relative;
            height: 100%;
        }
        
        #interactive.viewport > canvas, #interactive.viewport > video {
            max-width: 100%;
            width: 100%;
            height: auto;
        }
        
        canvas.drawing, canvas.drawingBuffer {
            position: absolute;
            left: 0;
            top: 0;
        }
        
        .history-card {
            transition: all 0.3s ease;
        }
        
        .history-card:hover {
            transform: translateY(-5px);
        }
        
        #scanner-container {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-black text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">ðŸ“¦ Barcode Scanner</h1>
                <div class="flex space-x-4">
                    <button id="toggleHistoryBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded transition">
                        History
                    </button>
                    <button id="toggleGenerateBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded transition">
                        Generate
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4">
            <!-- Scanner Section -->
            <div id="scanner-container" class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div id="permission-section" class="text-center py-12">
                    <h2 class="text-2xl font-bold mb-4">Enable Camera Access</h2>
                    <p class="mb-6 text-gray-700">We need your permission to access your camera to scan barcodes.</p>
                    <button id="requestPermissionBtn" class="bg-black text-white px-6 py-3 rounded-lg hover:bg-gray-800 transition">
                        Allow Camera Access
                    </button>
                </div>

                <div id="scanner-section" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Scan Barcode</h2>
                        <button id="toggleCameraBtn" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition">
                            Switch Camera
                        </button>
                    </div>
                    <div id="interactive" class="viewport bg-black rounded-lg overflow-hidden mb-4" style="height: 300px;"></div>
                    <div class="text-center">
                        <p id="scanStatus" class="text-gray-600">Place barcode within the viewfinder</p>
                    </div>
                </div>
            </div>

            <!-- Generate Section -->
            <div id="generate-container" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4">Generate Barcode</h2>
                <div class="mb-4">
                    <label for="barcodeText" class="block text-gray-700 mb-2">Enter text or URL:</label>
                    <input type="text" id="barcodeText" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-black">
                </div>
                <div class="mb-4">
                    <label for="barcodeType" class="block text-gray-700 mb-2">Barcode type:</label>
                    <select id="barcodeType" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-black">
                        <option value="CODE128">CODE128</option>
                        <option value="EAN13">EAN-13</option>
                        <option value="UPC">UPC</option>
                        <option value="CODE39">CODE39</option>
                        <option value="ITF14">ITF-14</option>
                    </select>
                </div>
                <button id="generateBarcodeBtn" class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-800 transition">
                    Generate Barcode
                </button>
                <div class="mt-6 flex justify-center">
                    <svg id="barcode" class="border p-2 rounded"></svg>
                </div>
                <div id="download-section" class="mt-4 hidden">
                    <button id="downloadBarcodeBtn" class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-800 transition">
                        Download Barcode
                    </button>
                </div>
            </div>

            <!-- History Section -->
            <div id="history-container" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Scan History</h2>
                <div id="history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center py-8">
                        <p class="text-gray-500">No scan history yet</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-black text-white p-4 text-center">
            <p>Â© 2023 Barcode Scanner. All rights reserved.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const permissionSection = document.getElementById('permission-section');
            const scannerSection = document.getElementById('scanner-section');
            const requestPermissionBtn = document.getElementById('requestPermissionBtn');
            const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
            const toggleGenerateBtn = document.getElementById('toggleGenerateBtn');
            const scannerContainer = document.getElementById('scanner-container');
            const generateContainer = document.getElementById('generate-container');
            const historyContainer = document.getElementById('history-container');
            const toggleCameraBtn = document.getElementById('toggleCameraBtn');
            const scanStatus = document.getElementById('scanStatus');
            const generateBarcodeBtn = document.getElementById('generateBarcodeBtn');
            const barcodeText = document.getElementById('barcodeText');
            const barcodeType = document.getElementById('barcodeType');
            const barcodeElement = document.getElementById('barcode');
            const downloadSection = document.getElementById('download-section');
            const downloadBarcodeBtn = document.getElementById('downloadBarcodeBtn');
            const historyList = document.getElementById('history-list');

            // State variables
            let currentStream = null;
            let facingMode = "environment"; // default: rear camera
            let scanHistory = JSON.parse(localStorage.getItem('scanHistory')) || [];

            // Initialize the app
            initApp();

            // Event Listeners
            requestPermissionBtn.addEventListener('click', initScanner);
            toggleHistoryBtn.addEventListener('click', toggleHistory);
            toggleGenerateBtn.addEventListener('click', toggleGenerate);
            toggleCameraBtn.addEventListener('click', toggleCamera);
            generateBarcodeBtn.addEventListener('click', generateBarcode);
            downloadBarcodeBtn.addEventListener('click', downloadBarcode);

            // Functions
            function initApp() {
                updateHistoryList();
            }

            function toggleHistory() {
                const isHistoryVisible = !historyContainer.classList.contains('hidden');
                
                scannerContainer.classList.toggle('hidden', !isHistoryVisible);
                generateContainer.classList.add('hidden');
                historyContainer.classList.toggle('hidden', isHistoryVisible);
                
                toggleHistoryBtn.classList.toggle('bg-white', !isHistoryVisible);
                toggleHistoryBtn.classList.toggle('text-black', !isHistoryVisible);
                toggleGenerateBtn.classList.remove('bg-white', 'text-black');
            }

            function toggleGenerate() {
                const isGenerateVisible = !generateContainer.classList.contains('hidden');
                
                scannerContainer.classList.toggle('hidden', !isGenerateVisible);
                generateContainer.classList.toggle('hidden', isGenerateVisible);
                historyContainer.classList.add('hidden');
                
                toggleGenerateBtn.classList.toggle('bg-white', !isGenerateVisible);
                toggleGenerateBtn.classList.toggle('text-black', !isGenerateVisible);
                toggleHistoryBtn.classList.remove('bg-white', 'text-black');
            }

            async function initScanner() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: facingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });

                    currentStream = stream;
                    permissionSection.classList.add('hidden');
                    scannerSection.classList.remove('hidden');
                    setUpScanner();
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    scanStatus.textContent = "Error accessing camera. Please check permissions.";
                }
            }

            function setUpScanner() {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#interactive'),
                        constraints: {
                            width: 480,
                            height: 320,
                            facingMode: facingMode
                        },
                    },
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "code_39_vin_reader", 
                                 "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
                    },
                    locator: {
                        halfSample: true,
                        patchSize: "medium",
                    },
                    locate: true,
                }, function(err) {
                    if (err) {
                        console.error(err);
                        scanStatus.textContent = "Failed to initialize scanner. Please try again.";
                        return;
                    }
                    scanStatus.textContent = "Place barcode within the viewfinder";
                    Quagga.start();
                });

                Quagga.onDetected(async function(result) {
                    const code = result.codeResult.code;
                    scanStatus.textContent = `Detected: ${code}`;
                    
                    // Stop scanning temporarily
                    Quagga.stop();
                    
                    // Add to history
                    addToHistory(code);
                    
                    // Check if the code is a URL and navigate to it
                    try {
                        let url = code;
                        if (!url.startsWith('http://') && !url.startsWith('https://')) {
                            url = 'http://' + url;
                        }
                        
                        // Show confirmation before redirecting
                        const shouldRedirect = confirm(`Do you want to navigate to:\n${url}`);
                        if (shouldRedirect) {
                            window.location.href = url;
                        } else {
                            // Resume scanning
                            Quagga.start();
                        }
                    } catch (e) {
                        console.error("Error navigating to URL:", e);
                        alert(`Barcode detected: ${code}`);
                        // Resume scanning
                        Quagga.start();
                    }
                });
            }

            function addToHistory(code) {
                const timestamp = new Date().toISOString();
                const scanItem = { code, timestamp };
                
                // Add to beginning of array (newest first)
                scanHistory.unshift(scanItem);
                
                // Keep only recent 50 scans
                if (scanHistory.length > 50) {
                    scanHistory.pop();
                }
                
                // Save to localStorage
                localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
                
                // Update the history list
                updateHistoryList();
            }

            function updateHistoryList() {
                if (scanHistory.length === 0) {
                    historyList.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500">No scan history yet</p>
                        </div>
                    `;
                    return;
                }
                
                historyList.innerHTML = scanHistory.map(item => `
                    <div class="history-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">${item.code}</span>
                            <span class="text-xs text-gray-500">${formatDate(item.timestamp)}</span>
                        </div>
                        <button onclick="handleHistoryAction('${item.code}')" class="bg-black text-white text-xs px-3 py-1 rounded hover:bg-gray-800 transition">
                            Copy
                        </button>
                    </div>
                `).join('');
            }

            function formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString();
            }

            async function toggleCamera() {
                if (!currentStream) return;
                
                // Stop current stream
                currentStream.getTracks().forEach(track => track.stop());
                
                // Toggle facing mode
                facingMode = facingMode === "user" ? "environment" : "user";
                
                // Reinitialize scanner with new camera
                await initScanner();
            }

            function generateBarcode() {
                const text = barcodeText.value.trim();
                const type = barcodeType.value;
                
                if (!text) {
                    alert("Please enter text or URL to generate barcode");
                    return;
                }
                
                try {
                    JsBarcode(barcodeElement, text, {
                        format: type,
                        lineColor: "#000000",
                        width: 2,
                        height: 80,
                        displayValue: true,
                        font: "monospace",
                        fontSize: 16
                    });
                    
                    downloadSection.classList.remove('hidden');
                } catch (e) {
                    alert("Error generating barcode: " + e.message);
                }
            }

            function downloadBarcode() {
                const canvas = document.querySelector("#barcode canvas");
                if (!canvas) return;
                
                const link = document.createElement('a');
                link.download = 'barcode.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }

            // Make this function available globally for history items
            window.handleHistoryAction = function(code) {
                navigator.clipboard.writeText(code).then(() => {
                    alert("Copied to clipboard: " + code);
                }).catch(err => {
                    console.error("Failed to copy text: ", err);
                    alert("Failed to copy text. Please try again.");
                });
            };

            // Clean up when leaving the page
            window.addEventListener('beforeunload', function() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                if (Quagga) {
                    Quagga.stop();
                }
            });
        });
    </script>
</body>
</html>
